#!/usr/bin/env php
<?php
declare(strict_types=1);

/**
 * Brick Component Creator
 * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Brick UI
 *
 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
 *   ./vendor/bin/brick 'PSR4Namespace'
 *
 * –ü—Ä–∏–º–µ—Ä:
 *   ./vendor/bin/brick 'My\Components\Button'
 *   ./vendor/bin/brick 'App\UI\Forms\LoginForm'
 */
class ComponentCreator
{
    private array $psr4Mappings = [];

    /**
     * @throws Exception
     */
    public function __construct()
    {
        $this->loadComposerConfig();
    }

    /**
     * @throws Exception
     */
    private function loadComposerConfig(): void
    {
        $composerPath = getcwd().'/composer.json';

        if (!file_exists($composerPath)) {
            throw new Exception("–§–∞–π–ª composer.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏");
        }

        $composerJson = file_get_contents($composerPath);
        $config = json_decode($composerJson, true);

        if (json_last_error() !== JSON_ERROR_NONE) {
            throw new Exception("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è composer.json: ".json_last_error_msg());
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º PSR-4 –º–∞–ø–ø–∏–Ω–≥–∏
        $this->psr4Mappings = $config['autoload']['psr-4'] ?? [];

        if (empty($this->psr4Mappings)) {
            throw new Exception("–í composer.json –Ω–µ –Ω–∞–π–¥–µ–Ω psr-4 –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫");
        }

        echo "üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω—ã PSR-4 –º–∞–ø–ø–∏–Ω–≥–∏:\n";
        foreach ($this->psr4Mappings as $namespace => $path) {
            echo "  $namespace => $path\n";
        }
        echo "\n";
    }

    /**
     * @throws Exception
     */
    private function resolveNamespaceToPath(string $namespace): string
    {
        $namespace = trim($namespace, '\\').'\\';

        foreach ($this->psr4Mappings as $nsPrefix => $relativePath) {
            $nsPrefix = trim($nsPrefix, '\\').'\\';

            if (str_starts_with($namespace, $nsPrefix)) {
                // –ù–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–µ—Ñ–∏–∫—Å
                $relativeClass = substr($namespace, strlen($nsPrefix));
                $relativeClass = trim($relativeClass, '\\');

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Ç—å
                $path = rtrim($relativePath, '/');
                if ($relativeClass !== '') {
                    $path .= '/'.str_replace('\\', '/', $relativeClass);
                }

                return getcwd().'/'.$path;
            }
        }

        throw new Exception(
            "–ù–µ –Ω–∞–π–¥–µ–Ω–æ PSR-4 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è namespace: $namespace\n".
            "–î–æ–±–∞–≤—å—Ç–µ –≤ composer.json:\n".
            "\"autoload\": {\n".
            "    \"psr-4\": {\n".
            "        \"".trim($namespace, '\\')."\\\\\": \"src/\"\n".
            "    }\n".
            "}",
        );
    }

    public function run(string $fullClassName): void
    {
        echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: $fullClassName\n";

        try {
            // –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª–Ω–æ–≥–æ –∏–º–µ–Ω–∏ –∫–ª–∞—Å—Å–∞
            $parsed = $this->parseClassName($fullClassName);
            $namespace = $parsed['namespace'];
            $componentName = $parsed['className'];

            echo "üìÅ –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º–µ–Ω: $namespace\n";
            echo "üß± –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: $componentName\n";

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ PSR-4
            $baseDir = $this->resolveNamespaceToPath($namespace);
            echo "üìÇ –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å: $baseDir\n";

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
            $componentDir = $this->createDirectoryStructure($baseDir, $componentName);

            $namespace = $namespace.'\\'.$componentName;

            // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            $this->createClassFile($componentDir, $namespace, $componentName);
            $this->createTemplateFile($componentDir, $namespace, $componentName);
            $this->createStyleFile($componentDir, $componentName);
            $this->createScriptFile($componentDir, $componentName);

            echo "\n‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!\n";
            echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $componentDir\n";

            $this->showUsageExample($namespace, $componentName);
        } catch (Exception $e) {
            echo "‚ùå –û—à–∏–±–∫–∞: ".$e->getMessage()."\n";
            exit(1);
        }
    }

    /**
     * @throws Exception
     */
    private function parseClassName(string $fullClassName): array
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏ –∫–ª–∞—Å—Å–∞
        if (!preg_match('/^[a-zA-Z_\x80-\xff][a-zA-Z0-9_\x80-\xff\\\\]*[a-zA-Z0-9_\x80-\xff]$/', $fullClassName)) {
            throw new Exception("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è –∫–ª–∞—Å—Å–∞: $fullClassName");
        }

        $parts = explode('\\', $fullClassName);

        if (count($parts) < 2) {
            throw new Exception("–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è –∫–ª–∞—Å—Å–∞ —Å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º –∏–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: Vendor\Component\Button)");
        }

        $className = array_pop($parts);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–º—è –∫–ª–∞—Å—Å–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç PSR
        if (!preg_match('/^[A-Z][a-zA-Z0-9]*$/', $className)) {
            throw new Exception("–ò–º—è –∫–ª–∞—Å—Å–∞ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã");
        }
        return [
            'namespace' => implode('\\', $parts),
            'className' => $className,
        ];
    }

    /**
     * @throws Exception
     */
    private function createDirectoryStructure(string $baseDir, string $componentName): string
    {
        $componentDir = $baseDir.'/'.$componentName;

        echo "üìÇ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $componentDir\n";

        // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        if (!is_dir($componentDir)) {
            if (!mkdir($componentDir, 0755, true)) {
                throw new Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $componentDir");
            }
        } elseif (count(scandir($componentDir)) > 2) {
            // –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –ø—É—Å—Ç–∞
            throw new Exception("–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $componentDir —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–∞");
        }

        return $componentDir;
    }

    private function createClassFile(string $componentDir, string $namespace, string $componentName): void
    {
        $filePath = $componentDir.'/'.$componentName.'.php';

        $content = <<<PHP
            <?php
            declare(strict_types=1);
            
            namespace $namespace;
            
            use OlegV\Brick;
            
            /**
             * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç $componentName
             *
             * @package $namespace
             */
            readonly class $componentName extends Brick
            {
                public function __construct(
                    public string \$text,
                    public string \$variant = 'primary'
                ) {
                    parent::__construct();
                }
            }
            PHP;

        file_put_contents($filePath, $content);
        echo "üìÑ –°–æ–∑–¥–∞–Ω: $componentName.php\n";
    }

    private function createTemplateFile(string $componentDir, string $namespace, string $componentName): void
    {
        $filePath = $componentDir.'/template.php';

        $content = <<<HTML
            <?php
            declare(strict_types=1);
            namespace $namespace;
            /** @var $componentName \$this */
            ?>
            <button class="btn btn-<?=\$this->e(\$this->variant)?>">
                <?=\$this->e(\$this->text)?>
            </button>
            HTML;

        file_put_contents($filePath, $content);
        echo "üìÑ –°–æ–∑–¥–∞–Ω: template.php\n";
    }

    private function createStyleFile(string $componentDir, string $componentName): void
    {
        $filePath = $componentDir.'/style.css';

        $content = <<<CSS
            /* –°—Ç–∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ $componentName */
            CSS;

        file_put_contents($filePath, $content);
        echo "üìÑ –°–æ–∑–¥–∞–Ω: style.css\n";
    }

    private function createScriptFile(string $componentDir, string $componentName): void
    {
        $filePath = $componentDir.'/script.js';

        $content = <<<JS
            // JavaScript –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ $componentName
            JS;

        file_put_contents($filePath, $content);
        echo "üìÑ –°–æ–∑–¥–∞–Ω: script.js\n";
    }

    private function showUsageExample(string $namespace, string $componentName): void
    {
        $fullClassName = $namespace.'\\'.$componentName;

        echo "\nüìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n";
        echo "// –í –≤–∞—à–µ–º –∫–æ–¥–µ\n";
        echo "use $fullClassName;\n";
        echo "echo new $componentName('–¢–µ–∫—Å—Ç', 'primary');\n";

        echo "\n‚ö° –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É:\n";
        echo "composer dump-autoload\n";
    }
}

// ===== CLI –æ–±—Ä–∞–±–æ—Ç–∫–∞ =====

if (PHP_SAPI !== 'cli') {
    die("üö´ –≠—Ç–∞ —É—Ç–∏–ª–∏—Ç–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è CLI –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.\n");
}

echo "üß± Brick Component Creator\n";
echo "==========================\n\n";

if ($argc < 2) {
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n";
    echo "  ./vendor/bin/".basename(__FILE__)." 'PSR4Namespace'\n\n";
    echo "–ü—Ä–∏–º–µ—Ä—ã:\n";
    echo "  ./vendor/bin/".basename(__FILE__)." 'My\\Components\\Button'\n";
    echo "  ./vendor/bin/".basename(__FILE__)." 'App\\UI\\Forms\\LoginForm'\n";
    echo "  ./vendor/bin/".basename(__FILE__)." 'Company\\Project\\Cards\\ProductCard'\n\n";
    echo "–í–∞–∂–Ω–æ:\n";
    echo "  ‚Ä¢ Composer.json –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å PSR-4 –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É\n";
    echo "  ‚Ä¢ –ò–º—è –∫–ª–∞—Å—Å–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å PSR-—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º\n";
    exit(1);
}

$fullClassName = $argv[1];

// –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
$fullClassName = trim($fullClassName, "'\"");

// –ó–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
try {
    $creator = new ComponentCreator();
    $creator->run($fullClassName);
} catch (Exception $e) {
    echo "‚ùå –û—à–∏–±–∫–∞: ".$e->getMessage()."\n";
    exit(1);
}